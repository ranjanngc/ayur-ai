<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Charaka Samhita AI Assistant</title>
    <script src="https://cdn.jsdelivr.net/npm/marked/lib/marked.umd.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/github-markdown-css/5.5.1/github-markdown.min.css">
    <style>
        body { font-family: 'Segoe UI', sans-serif; max-width: 900px; margin: 0 auto; padding: 20px; background: #f7f9fc; }
        h1 { text-align: center; color: #2c3e50; }
        .subtitle { text-align: center; color: #7f8c8d; margin-bottom: 30px; }
        #chat-container { background: white; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.1); height: 70vh; overflow-y: auto; padding: 20px; margin-bottom: 20px; }
        .message { margin: 15px 0; padding: 16px 22px; border-radius: 20px; max-width: 85%; line-height: 1.8; }
        .user { background: #3498db; color: white; margin-left: auto; border-bottom-right-radius: 4px; }
        .bot { background: #ffffff; color: #2c3e50; margin-right: auto; border-bottom-left-radius: 4px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); }
        .status { font-style: italic; color: #7f8c8d; text-align: center; margin: 20px 0; }
        .sources { margin-top: 30px; padding-top: 20px; border-top: 1px solid #e0e0e0; }
        .source-item { background: #f8f9fa; padding: 14px; border-radius: 10px; margin: 12px 0; border-left: 5px solid #3498db; }
        #input-area { display: flex; gap: 12px; }
        #question { flex: 1; padding: 18px; border: 1px solid #ddd; border-radius: 12px; font-size: 16px; }
        #question:focus { border-color: #3498db; }
        #send-btn { padding: 18px 36px; background: #27ae60; color: white; border: none; border-radius: 12px; cursor: pointer; }
        #send-btn:hover:not(:disabled) { background: #219a52; }
        #send-btn:disabled { background: #95a5a6; cursor: not-allowed; }
        .markdown-body { padding: 10px; }
    </style>
</head>
<body>
    <h1>ðŸŒ¿ Charaka Samhita AI Assistant</h1>
    <p class="subtitle">Authentic wisdom from Charaka Samhita with real-time streaming</p>

    <div id="chat-container"></div>

    <div id="input-area">
        <input type="text" id="question" placeholder="Ask about remedies, causes, doshas..." autocomplete="off" />
        <button id="send-btn">Send</button>
    </div>

    <script>
        const chatContainer = document.getElementById("chat-container");
        const input = document.getElementById("question");
        const sendBtn = document.getElementById("send-btn");
        let ws = null;
        let currentFullAnswer = "";

        function addMessage(text, type = "bot") {
            const div = document.createElement("div");
            div.className = `message ${type}`;
            if (type === "bot") div.classList.add("markdown-body");
            div.innerHTML = marked.parse(text || "");
            chatContainer.appendChild(div);
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        function addStatus(text) {
            const div = document.createElement("div");
            div.className = "status";
            div.textContent = text;
            chatContainer.appendChild(div);
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        function appendPlain(text) {
            const last = chatContainer.lastElementChild;
            if (last && last.classList.contains("bot")) {
                last.textContent += text;
                chatContainer.scrollTop = chatContainer.scrollHeight;
            }
        }

        function finalizeMarkdown(fullText) {
            const last = chatContainer.lastElementChild;
            if (!last || !last.classList.contains("bot")) return;

            let fixed = fullText.trim()
                .replace(/([.!?])\s*([A-Z])/g, '$1\n\n$2')
                .replace(/\n{3,}/g, '\n\n');

            last.innerHTML = marked.parse(fixed);
            last.classList.add("markdown-body");
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        function addSources(sources) {
            if (!sources?.length) return;
            const div = document.createElement("div");
            div.className = "sources";
            div.innerHTML = "<strong>ðŸ“œ Sources from Charaka Samhita:</strong>";
            sources.forEach(s => {
                const item = document.createElement("div");
                item.className = "source-item";
                item.innerHTML = `<strong>[${s.index}]</strong> ${marked.parse(s.text)}`;
                div.appendChild(item);
            });
            chatContainer.appendChild(div);
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        function sendMessage() {
            const q = input.value.trim();
            if (!q || !ws || ws.readyState !== WebSocket.OPEN) return;

            addMessage(q, "user");
            ws.send(JSON.stringify({ question: q }));
            input.value = "";
            sendBtn.disabled = true;
            addStatus("Searching Charaka Samhita...");
        }

        function connect() {
            ws = new WebSocket(`ws://${location.host}/ws`);

            ws.onopen = () => {
                addStatus("Connected â€” ready!");
                sendBtn.disabled = false;
            };

            ws.onmessage = (event) => {
                const data = JSON.parse(event.data);

                if (data.type === "status") addStatus(data.message);
                else if (data.type === "start") {
                    addMessage("", "bot");
                    currentFullAnswer = "";
                } else if (data.type === "token") {
                    currentFullAnswer += data.token;
                    appendPlain(data.token);
                } else if (data.type === "end_rag") {
                    console.log(currentFullAnswer)
                    finalizeMarkdown(currentFullAnswer.trim());
                    addSources(data.sources);
                } else if (data.type === "error") {
                    addMessage(`**Error:** ${data.message}`, "bot");
                }
            };

            ws.onclose = () => {
                addStatus("Connection lost. Reconnecting...");
                sendBtn.disabled = true;
                setTimeout(connect, 3000);
            };
        }

        sendBtn.addEventListener("click", sendMessage);
        input.addEventListener("keypress", e => e.key === "Enter" && sendMessage());
        connect();
    </script>
</body>
</html>